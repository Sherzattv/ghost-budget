<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ghost Budget</title>
  <meta name="description" content="–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä –±—é–¥–∂–µ—Ç–∞">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1A1A1A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Auth Screen (shown when not logged in) -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-container">
      <div class="auth-header">
        <span class="logo-text">ghost<span class="logo-accent">budget</span></span>
        <p class="auth-subtitle">–í–æ–π–¥–∏ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
      </div>

      <div class="auth-tabs" id="auth-tabs">
        <button class="tab active" data-tab="login">–í—Ö–æ–¥</button>
        <button class="tab" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- Login Form -->
      <form class="auth-form" id="login-form">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
          <input type="password" class="form-input" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
        </div>
        <div class="auth-error" id="login-error"></div>
        <button type="submit" class="btn btn-primary btn-full" id="login-btn">–í–æ–π—Ç–∏</button>
      </form>

      <!-- Register Form -->
      <form class="auth-form" id="register-form" style="display: none;">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="register-email" placeholder="email@example.com" required>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
          <input type="password" class="form-input" id="register-password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required
            minlength="6">
        </div>
        <div class="auth-error" id="register-error"></div>
        <button type="submit" class="btn btn-primary btn-full" id="register-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
      </form>
    </div>
  </div>

  <!-- App Layout (shown when logged in) -->
  <div class="app-layout" id="app-layout" style="display: none;">
    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="header">
        <div class="logo">
          <span class="logo-text">ghost<span class="logo-accent">budget</span></span>
          <div id="server-status" class="status-indicator online" title="Supabase connected"></div>
        </div>
        <div class="header-actions">
          <button class="btn btn-ghost btn-sm" id="btn-manage-accounts">–°—á–µ—Ç–∞</button>
          <div class="user-menu" id="user-menu">
            <button class="btn btn-ghost btn-sm user-btn" id="user-btn">
              <span id="user-email">user</span> ‚ñæ
            </button>
            <div class="user-dropdown" id="user-dropdown">
              <button class="dropdown-item" id="btn-logout">–í—ã–π—Ç–∏</button>
            </div>
          </div>
        </div>
      </header>

      <!-- Balance Section -->
      <section class="section">
        <div class="section-header">
          <h2 class="section-title">–ë–∞–ª–∞–Ω—Å</h2>
          <div class="balance-wrapper">
            <div class="balance-item">
              <span class="balance-label">–°–≤–æ–∏</span>
              <span class="balance-value" id="own-balance">‚Ç∏0</span>
            </div>
            <div class="balance-item">
              <span class="balance-label">–õ–∏–º–∏—Ç</span>
              <span class="balance-value credit" id="credit-balance">‚Ç∏0</span>
            </div>
          </div>
        </div>
        <div class="accounts-grid" id="accounts-grid">
          <!-- Accounts will be rendered here -->
        </div>
      </section>

      <!-- Obligations Section (Receivables + Liabilities) -->
      <section class="section section-obligations" id="obligations-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title">–î–æ–ª–≥–∏ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</h2>
          <div class="obligations-summary">
            <span class="summary-positive" id="total-receivables">+‚Ç∏0</span>
            <span class="summary-negative" id="total-liabilities">‚àí‚Ç∏0</span>
          </div>
        </div>
        <!-- –ú–Ω–µ –¥–æ–ª–∂–Ω—ã -->
        <div class="obligations-group" id="receivables-group">
          <h3 class="group-label positive">‚Üë –ú–Ω–µ –¥–æ–ª–∂–Ω—ã</h3>
          <div class="obligations-row" id="receivables-row"></div>
        </div>
        <!-- –Ø –¥–æ–ª–∂–µ–Ω -->
        <div class="obligations-group" id="liabilities-group">
          <h3 class="group-label negative">‚Üì –Ø –¥–æ–ª–∂–µ–Ω</h3>
          <div class="obligations-row" id="liabilities-row"></div>
        </div>
      </section>

      <!-- Analytics Section -->
      <section class="section">
        <div class="section-header">
          <h2 class="section-title">–ö—É–¥–∞ —É—Ö–æ–¥—è—Ç –¥–µ–Ω—å–≥–∏</h2>
          <select class="period-select" id="period-select">
            <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
            <option value="week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
            <option value="all">–í—Å—ë –≤—Ä–µ–º—è</option>
          </select>
        </div>
        <div class="analytics" id="analytics">
          <!-- Analytics will be rendered here -->
        </div>
      </section>

      <!-- Transactions Section -->
      <section class="section">
        <h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
        <div class="transactions" id="transactions">
          <!-- Transactions will be rendered here -->
        </div>
      </section>

      <!-- Footer -->
      <footer class="footer">
        <span>–¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ</span>
      </footer>
    </main>

    <!-- Side Panel: Add Transaction -->
    <aside class="side-panel">
      <button class="panel-close" id="panel-close">&times;</button>
      <h3 class="panel-title">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>

      <div class="tabs" id="transaction-tabs">
        <button class="tab active" data-type="expense">–†–∞—Å—Ö–æ–¥</button>
        <button class="tab" data-type="income">–î–æ—Ö–æ–¥</button>
        <button class="tab" data-type="transfer">–ü–µ—Ä–µ–≤–æ–¥</button>
        <button class="tab" data-type="debt">–î–æ–ª–≥</button>
      </div>

      <form id="transaction-form">
        <div class="form-group">
          <label class="form-label">–°—É–º–º–∞</label>
          <input type="number" class="form-input form-input-amount" id="input-amount" placeholder="0" required>
        </div>

        <div class="form-group" id="group-category">
          <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <input type="text" class="form-input" id="input-category" list="categories-list"
            placeholder="–í—ã–±–µ—Ä–∏ –∏–ª–∏ –≤–≤–µ–¥–∏">
          <datalist id="categories-list"></datalist>
        </div>

        <div class="form-group" id="group-account">
          <label class="form-label">–°—á—ë—Ç</label>
          <select class="form-select" id="input-account"></select>
        </div>

        <div class="form-group" id="group-from-account" style="display: none;">
          <label class="form-label">–û—Ç–∫—É–¥–∞</label>
          <select class="form-select" id="input-from-account"></select>
        </div>

        <div class="form-group" id="group-to-account" style="display: none;">
          <label class="form-label">–ö—É–¥–∞</label>
          <select class="form-select" id="input-to-account"></select>
        </div>

        <!-- Debt Form Fields -->
        <!-- Step 1: Operation buttons (2x2 grid) -->
        <div class="form-group" id="group-debt-action" style="display: none;">
          <label class="form-label">–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?</label>
          <div class="debt-action-buttons">
            <button type="button" class="debt-action-btn" data-action="lend">
              <span class="action-icon">üí∏</span>
              <span class="action-text">–Ø –¥–∞–ª</span>
            </button>
            <button type="button" class="debt-action-btn" data-action="borrow">
              <span class="action-icon">üí∞</span>
              <span class="action-text">–Ø –≤–∑—è–ª</span>
            </button>
            <button type="button" class="debt-action-btn" data-action="collect">
              <span class="action-icon">‚úÖ</span>
              <span class="action-text">–ú–Ω–µ –≤–µ—Ä–Ω—É–ª–∏</span>
            </button>
            <button type="button" class="debt-action-btn" data-action="repay">
              <span class="action-icon">‚Ü©Ô∏è</span>
              <span class="action-text">–Ø –≤–µ—Ä–Ω—É–ª</span>
            </button>
          </div>
          <input type="hidden" id="input-debt-action" value="">
        </div>

        <!-- Step 2: Debt type (only for "borrow") -->
        <div class="form-group" id="group-debt-type" style="display: none;">
          <label class="form-label">–¢–∏–ø</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="debt-type" value="person" checked>
              <span>–ß–µ–ª–æ–≤–µ–∫</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="debt-type" value="credit">
              <span>–ö—Ä–µ–¥–∏—Ç/–†–∞—Å—Å—Ä–æ—á–∫–∞</span>
            </label>
          </div>
        </div>

        <!-- Step 3: Credit/Installment toggle -->
        <div class="form-group" id="group-credit-toggle" style="display: none;">
          <div class="toggle-group">
            <button type="button" class="toggle-btn active" data-credit-type="credit">–ö—Ä–µ–¥–∏—Ç</button>
            <button type="button" class="toggle-btn" data-credit-type="installment">–†–∞—Å—Å—Ä–æ—á–∫–∞</button>
          </div>
        </div>

        <!-- Counterparty input (autocomplete from history) -->
        <div class="form-group" id="group-counterparty" style="display: none;">
          <label class="form-label" id="label-counterparty">–ö–æ–º—É</label>
          <input type="text" class="form-input" id="input-counterparty" list="counterparties-list"
            placeholder="–ò–º—è –∏–ª–∏ –±–∞–Ω–∫">
          <datalist id="counterparties-list"></datalist>
        </div>

        <!-- Counterparty select (for collect/repay) -->
        <div class="form-group" id="group-counterparty-select" style="display: none;">
          <label class="form-label" id="label-counterparty-select">–ö—Ç–æ</label>
          <select class="form-select" id="input-counterparty-select"></select>
        </div>

        <!-- Credit-specific fields -->
        <div class="form-group" id="group-monthly-payment" style="display: none;">
          <label class="form-label">–ü–ª–∞—Ç—ë–∂/–º–µ—Å <span class="optional">(–æ–ø—Ü.)</span></label>
          <input type="number" class="form-input" id="input-monthly-payment" placeholder="0">
        </div>

        <div class="form-group" id="group-payment-day" style="display: none;">
          <label class="form-label">–î–µ–Ω—å –ø–ª–∞—Ç–µ–∂–∞ <span class="optional">(1-28)</span></label>
          <input type="number" class="form-input" id="input-payment-day" min="1" max="28" placeholder="15">
        </div>

        <div class="form-group" id="group-interest-rate" style="display: none;">
          <label class="form-label">% –≥–æ–¥–æ–≤—ã—Ö <span class="optional">(–æ–ø—Ü.)</span></label>
          <input type="number" class="form-input" id="input-interest-rate" step="0.1" placeholder="0">
        </div>

        <!-- Return date -->
        <div class="form-group" id="group-return-date" style="display: none;">
          <label class="form-label">–í–µ—Ä–Ω—É—Ç—å –¥–æ <span class="optional">(–æ–ø—Ü.)</span></label>
          <input type="date" class="form-input" id="input-return-date">
        </div>

        <div class="form-group">
          <label class="form-label">–ó–∞–º–µ—Ç–∫–∞ <span class="optional">(–æ–ø—Ü.)</span></label>
          <input type="text" class="form-input" id="input-note" placeholder="...">
        </div>

        <button type="submit" class="btn btn-primary btn-full" id="btn-add-transaction">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>

      <div class="panel-footer">
        <span class="shortcut-hint">Enter ‚Äî –¥–æ–±–∞–≤–∏—Ç—å</span>
      </div>
    </aside>
  </div>

  <!-- FAB for Mobile -->
  <button class="fab-add" id="fab-add">+</button>

  <!-- Modal: Manage Accounts -->
  <div class="modal-overlay" id="modal-accounts">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏</h3>
        <button class="modal-close" id="modal-accounts-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tabs" id="accounts-tabs">
          <button class="tab active" data-tab="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
          <button class="tab" data-tab="archived">–ê—Ä—Ö–∏–≤</button>
        </div>
        <div class="accounts-list" id="accounts-list">
          <!-- Active accounts will be rendered here -->
        </div>
        <div class="accounts-list" id="archived-accounts-list" style="display: none;">
          <!-- Archived accounts will be rendered here -->
        </div>

        <div class="divider"></div>

        <form id="add-account-form">
          <h4 class="form-subtitle">–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" class="form-input" id="new-account-name" name="name" placeholder="–ú–æ–π —Å—á—ë—Ç" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" id="label-balance">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</label>
              <input type="number" class="form-input" id="new-account-balance" name="balance" placeholder="0" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">–¢–∏–ø</label>
              <select class="form-select" id="new-account-type" name="type">
                <option value="asset">–ê–∫—Ç–∏–≤</option>
                <option value="credit_card">–ö—Ä–µ–¥–∏—Ç–∫–∞</option>
                <option value="savings">–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ</option>
              </select>
            </div>
          </div>
          <div class="form-group" id="group-new-credit-limit" style="display: none;">
            <label class="form-label">–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç</label>
            <input type="number" class="form-input" id="new-account-limit" name="credit_limit" placeholder="100000">
          </div>
          <button type="submit" class="btn btn-primary btn-full">–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Modify Account -->
  <div class="modal-overlay" id="modal-modify-account">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞</h3>
        <button class="modal-close" id="modal-modify-account-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="modify-account-form">
          <input type="hidden" id="modify-account-id">

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" class="form-input" id="modify-account-name" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">–ë–∞–ª–∞–Ω—Å (—Ñ–∞–∫—Ç)</label>
              <input type="number" class="form-input" id="modify-account-balance" required>
            </div>
            <div class="form-group">
              <label class="form-label">–¢–∏–ø</label>
              <select class="form-select" id="modify-account-type" disabled title="–¢–∏–ø –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å">
                <option value="asset">–ê–∫—Ç–∏–≤</option>
                <option value="savings">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
                <option value="receivable">–ú–Ω–µ –¥–æ–ª–∂–Ω—ã</option>
                <option value="liability">–Ø –¥–æ–ª–∂–µ–Ω</option>
              </select>
            </div>
          </div>

          <!-- Asset/Savings: Credit Limit -->
          <div class="form-group" id="modify-group-credit-limit" style="display: none;">
            <label class="form-label">–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç</label>
            <input type="number" class="form-input" id="modify-account-limit" placeholder="0">
          </div>

          <!-- Receivable/Liability: Counterparty -->
          <div class="form-group" id="modify-group-counterparty" style="display: none;">
            <label class="form-label">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label>
            <input type="text" class="form-input" id="modify-account-counterparty" placeholder="–ò–º—è –¥–æ–ª–∂–Ω–∏–∫–∞">
          </div>

          <!-- Receivable/Liability: Expected Return Date -->
          <div class="form-group" id="modify-group-return-date" style="display: none;">
            <label class="form-label">–û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
            <input type="date" class="form-input" id="modify-account-return-date">
          </div>

          <button type="submit" class="btn btn-primary btn-full">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Confirm Delete Account -->
  <div class="modal-overlay" id="modal-confirm-delete">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h3 class="modal-title">–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç?</h3>
        <button class="modal-close" id="modal-confirm-delete-close">&times;</button>
      </div>
      <div class="modal-body">
        <p class="delete-warning">
          –°–æ —Å—á—ë—Ç–æ–º —Å–≤—è–∑–∞–Ω–æ <strong id="delete-tx-count">0</strong> —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
          –û–Ω–∏ —Ç–æ–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.
        </p>
        <div class="modal-actions">
          <button class="btn btn-ghost" id="btn-archive-account">üìÅ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn btn-danger" id="btn-confirm-delete">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <script type="module" src="js/main.js"></script>
  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW error:', err));
    }
  </script>
</body>

</html>